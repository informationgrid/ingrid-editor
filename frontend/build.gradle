/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
  id 'base'
  id "com.github.node-gradle.node" version "2.2.4"
}

repositories {
  maven {
    url = 'https://nexus.informationgrid.eu/repository/maven-public'
  }
}

group = 'de.ingrid'
description = 'IGE-NG Frontend'

node {
  version = '14.17.1'
  download = true
}

task bundle(type: YarnTask) {
  inputs.dir(fileTree("node_modules").exclude(".cache"))
  inputs.dir('src')
  inputs.files('package.json', 'package-lock.json', 'angular.json', 'tsconfig.json', 'tsconfig.app.json')

  outputs.dir('build/dist')

  dependsOn yarn_install

  if (hasProperty('baseHref')) {
    args = ['run', 'prod', '--base-href', getProperty('baseHref')]
  } else {
    args = ['run', 'prod']
  }
}

task test(type: YarnTask) {
  args = ['run', 'test-headless']
}

task testFormatting(type: YarnTask) {
  args = ['prettier', '--check', "."]
}

task packageNpmApp(type: Zip) {
  dependsOn bundle
  baseName 'ige-frontend-app'
  extension 'jar'
  destinationDir file("${projectDir}/build/packageApp")
  duplicatesStrategy = DuplicatesStrategy.INCLUDE
  from('build/dist') {
    // optional path under which output will be visible in Java classpath, e.g. static resources path
    into 'static'
  }
  from ('src/assets') {
    into 'static/assets'
    include 'config.prod.json'
    rename { 'config.json' }
  }
}

configurations {
  npmResources
}
configurations.default.extendsFrom(configurations.npmResources)

if (hasProperty('buildProfile')) {
  artifacts {
    npmResources(packageNpmApp.archivePath) {
      builtBy packageNpmApp
      type "jar"
    }
  }
}

clean {
  // do nothing to improve speed
  // delete packageNpmApp.archivePath
}
