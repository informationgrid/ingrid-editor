/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
  id 'base'
  id "com.github.node-gradle.node" version "3.4.0"
}

repositories {
  maven {
    url = 'https://nexus.informationgrid.eu/repository/maven-public'
  }
}

group = 'de.ingrid'
description = 'IGE-NG Frontend'

node {
  version = '18.12.1'
  download = true
}

def buildArgs = ['run', 'prod']
if (hasProperty('baseHref')) {
  buildArgs = ['run', 'prod', '--base-href', getProperty('baseHref')]
}

task yarnUpgrade(type: YarnTask, dependsOn: 'yarnSetup') {
  args = ['set', 'version', 'stable']     // maybe with `yarn set version 3.x` also
}

task yarnInstall(type: YarnTask, dependsOn: 'yarnUpgrade') {
  args = ['install', '--immutable']
}

task bundle(type: YarnTask, dependsOn: 'yarnInstall') {
  inputs.dir(fileTree("node_modules").exclude(".cache"))
  inputs.dir('src')
  inputs.files('package.json', 'package-lock.json', 'angular.json', 'tsconfig.json', 'tsconfig.app.json')

  outputs.dir('build/dist')

  args = buildArgs
}

task test(type: YarnTask) {
  args = ['run', 'test-headless']
}

task testFormatting(type: YarnTask) {
  args = ['prettier', '--check', "."]
}

task packageNpmApp(type: Zip) {
  dependsOn bundle
  archiveFileName = 'ige-frontend-app.jar'
  destinationDirectory = file("${projectDir}/build/packageApp")
  duplicatesStrategy = DuplicatesStrategy.INCLUDE
  from('build/dist') {
    // optional path under which output will be visible in Java classpath, e.g. static resources path
    into 'static'
  }
  from ('src/assets') {
    into 'static/assets'
    include 'config.prod.json'
    rename { 'config.json' }
  }
}

configurations {
  npmResources
}
configurations.default.extendsFrom(configurations.npmResources)

if (hasProperty('buildProfile')) {
  artifacts {
    npmResources(packageNpmApp.archivePath) {
      builtBy packageNpmApp
      type "jar"
    }
  }
}

clean {
  // do nothing to improve speed
  // delete packageNpmApp.archivePath
  delete "./target"
}
