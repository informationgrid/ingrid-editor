<page-template label="Indizierung">
    <ng-container left-side>
        <div>
            Hier wird festgelegt, in welchen Zeitabständen der Katalog indiziert
            werden soll. Für die Definition des Intervalls wird der Cron
            Ausdruck verwendet.
        </div>
        <p>Ein Cron Ausdruck ist folgendermaßen aufgebaut:</p>

        <div class="cron-explain">
            <div>
                <div class="explain">Sekunde</div>
                <div class="star">*</div>
            </div>
            <div>
                <div class="explain">Minute</div>
                <div class="star">*</div>
            </div>
            <div>
                <div class="explain">Stunde</div>
                <div class="star">*</div>
            </div>
            <div>
                <div class="explain">Tag des Monats</div>
                <div class="star">*</div>
            </div>
            <div>
                <div class="explain">Monat</div>
                <div class="star">*</div>
            </div>
            <div>
                <div class="explain">Tag der Woche</div>
                <div class="star">*</div>
            </div>
        </div>

        <div>
            Beispiele:
            <mat-chip-listbox>
                <mat-chip-option (click)="cronField.setValue('0 */30 * * * *')"
                    >Alle 30 Minuten
                </mat-chip-option>
                <mat-chip-option (click)="cronField.setValue('0 0 3 * * *')"
                    >Täglich um 3 Uhr
                </mat-chip-option>
                <mat-chip-option (click)="cronField.setValue('0 0 23 * * 6,7')"
                    >23 Uhr am Wochenende
                </mat-chip-option>
                <mat-chip-option
                    (click)="cronField.setValue('0 0 8,11 * * 1-5')"
                    >Mo-Fr 8 und 11 Uhr
                </mat-chip-option>
            </mat-chip-listbox>
        </div>

        <p>
            Weitere Information über die Verwendung des Cron-Ausdrucks kann hier
            nachgelesen werden:
            <a target="_blank" href="https://de.wikipedia.org/wiki/Cron"
                >Link</a
            >
        </p>
        <p>
            Der Cron-Ausdruck beinhaltet zusätzlich die Einstellung von
            Sekunden, um eine genauere Ausführung zu definieren.
        </p>
    </ng-container>

    <div main-header *ngIf="isActivated; else noElasticsearch">
        <div fxFlex fxLayoutAlign="center center" fxLayoutGap="12px">
            <ng-container *ngIf="liveImportMessage | async as log">
                <mat-icon
                    *ngIf="log.errors.length > 0"
                    class="error-color"
                    matTooltip="Bei der letzten Indizierung trat ein Fehler auf"
                    >error_outline</mat-icon
                >

                <span *ngIf="log.endTime"
                    >Letzte Indizierung erfolgte am
                    {{ log.startTime | date : "dd.LL.yyyy HH:mm" }}</span
                >
                <ng-container *ngIf="!log.endTime">
                    <span fxLayout>
                        <mat-progress-spinner
                            [value]="
                                (log.progressDocuments / log.numDocuments) * 100
                            "
                            diameter="16"
                            [matTooltip]="
                                (
                                    (log.progressDocuments / log.numDocuments) *
                                    100
                                ).toFixed(0) + '% analysiert'
                            "
                        ></mat-progress-spinner>
                    </span>
                    <span
                        >Laufende Indizierung seit:
                        {{ log.startTime | date : "dd.LL.yyyy HH:mm:ss" }}</span
                    >
                </ng-container>
                <button
                    mat-icon-button
                    class="dark menu-button"
                    [class.expanded]="showMore"
                    (click)="showMore = !showMore"
                >
                    <mat-icon class="animated">keyboard_arrow_down</mat-icon>
                </button>
            </ng-container>
        </div>

        <div class="index-btn">
            <button
                *ngIf="!indexingIsRunning; else indexing"
                mat-flat-button
                color="primary"
                class="start-index"
                [disabled]="!initialized"
                (click)="index()"
            >
                Indizieren
            </button>
            <ng-template #indexing>
                <button
                    mat-flat-button
                    (click)="cancelIndexing()"
                    class="cancel-index"
                >
                    Indizierung abbrechen
                </button>
            </ng-template>
        </div>
    </div>

    <div status class="status" [class.hide]="!showMore">
        <div class="copy-button-area">
            <div class="extra-large-spacing link-text">
                <a href="#" (click)="copyContent($event)">Kopieren</a>
            </div>
        </div>

        <div #indexContent>
            <ige-log-result [data]="liveImportMessage"></ige-log-result>
        </div>
    </div>

    <div main-content fxFlex>
        <section>Ausführungsintervall</section>
        <div class="padding section">
            <mat-form-field class="width-100" appearance="outline">
                <mat-label>Cron Ausdruck</mat-label>
                <input
                    [formControl]="cronField"
                    matInput
                    placeholder="*/1 * * * * *"
                />
                <mat-hint>{{ hint }}</mat-hint>
            </mat-form-field>
            <div>
                <button
                    mat-stroked-button
                    (click)="deactivateIndexing()"
                    [disabled]="!cronField.value"
                >
                    Keine zeitliche Indizierung
                </button>
                <div fxFlex></div>
                <button
                    mat-stroked-button
                    color="primary"
                    (click)="updatePattern(cronField.value)"
                    [disabled]="!valid"
                >
                    Übernehmen
                </button>
            </div>
        </div>
    </div>

    <ng-template #noElasticsearch>
        Elasticsearch ist nicht im Backend aktiviert, welches für die
        Indizierung benötigt wird.
    </ng-template>
</page-template>
