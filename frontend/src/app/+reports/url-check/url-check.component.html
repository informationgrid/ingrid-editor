<page-template label="URL-Pflege">
    <div left-side></div>
    <div main-header>
        <div fxFlex fxLayoutAlign="center center" fxLayoutGap="12px">
            <ng-container *ngIf="liveLog | async as log">
                <span *ngIf="!isRunning; else running"
                    >Letzte Prüfung erfolgte am
                    {{ log.startTime | date: "dd.LL.yyyy HH:mm" }}</span
                >
                <ng-template #running>
                    <mat-progress-spinner
                        [value]="log.progress"
                        diameter="16"
                        [matTooltip]="log.progress + '%'"
                    ></mat-progress-spinner>
                    <span>
                        Laufende Prüfung seit:
                        {{ log.startTime | date: "dd.LL.yyyy HH:mm:ss" }}</span
                    >
                </ng-template>
                <button
                    mat-icon-button
                    class="dark menu-button"
                    [class.expanded]="showMore"
                    (click)="showMore = !showMore"
                >
                    <mat-icon class="animated">keyboard_arrow_down</mat-icon>
                </button>
            </ng-container>
        </div>

        <div class="report-btn">
            <button
                *ngIf="!isRunning; else stopJob"
                mat-flat-button
                color="primary"
                (click)="start()"
            >
                Prüfung starten
            </button>
            <ng-template #stopJob>
                <button mat-flat-button color="primary" (click)="stop()">
                    Prüfung stoppen
                </button>
            </ng-template>
        </div>
    </div>

    <div status class="status" [class.hide]="!showMore">
        <div *ngIf="liveLog | async as log">
            <div>Start: {{ log.startTime | date: "dd.LL.yyyy HH:mm:ss" }}</div>
            <div>Ende: {{ log.endTime | date: "dd.LL.yyyy HH:mm:ss" }}</div>
            <div>Analysierte URLs: {{ log.report.length }}</div>
        </div>
    </div>

    <div
        *ngIf="dataSource.data?.length > 0; else noData"
        main-content
        fxLayout="column"
        fxLayoutGap="36px"
    >
        <table
            mat-table
            [dataSource]="dataSource"
            matSort
            class="width-100 no-action-column"
        >
            <ng-container matColumnDef="_select_" class="thin-column">
                <th mat-header-cell *matHeaderCellDef>Alle</th>
                <td mat-cell *matCellDef="let element">
                    <mat-checkbox
                        (click)="$event.stopPropagation()"
                        (change)="$event ? selection.toggle(element) : null"
                        [checked]="selection.isSelected(element)"
                    >
                        <!--[aria-label]="checkboxLabel(row)"-->
                    </mat-checkbox>
                </td>
            </ng-container>
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    Status
                </th>
                <td mat-cell *matCellDef="let element">
                    {{ element.status }}
                </td>
            </ng-container>
            <ng-container matColumnDef="url">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>URL</th>
                <td mat-cell *matCellDef="let element">
                    <div>
                        <a
                            class="no-text-transform"
                            [href]="element.url"
                            target="_blank"
                            >{{ element.url }}</a
                        >
                    </div>
                </td>
            </ng-container>
            <ng-container matColumnDef="datasets">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    Datensätze
                </th>
                <td mat-cell *matCellDef="let element">
                    <div
                        *ngFor="let doc of element.datasets"
                        class="clickable-text"
                        (click)="loadDataset(doc.uuid)"
                    >
                        <!--                    <mat-icon [svgIcon]="element.type"></mat-icon>-->
                        {{ doc.title }} ({{ doc.field }})
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
                mat-row
                *matRowDef="let row; columns: displayedColumns"
                (click)="selection.toggle(row)"
            ></tr>
        </table>

        <div>
            <div class="section-title">
                Markierte URL in allen Datensätze durch folgende URL ersetzen:
            </div>

            <div fxLayout="row" fxLayoutGap="12px">
                <mat-form-field appearance="outline" fxFlex class="white-bg">
                    <input
                        matInput
                        placeholder="URL"
                        [disabled]="selection.isEmpty()"
                    />
                    <mat-hint *ngIf="selection.isEmpty()"
                        >Bitte wählen Sie zuerst eine URL aus</mat-hint
                    >
                </mat-form-field>
                <div style="padding-top: 7px">
                    <button
                        mat-stroked-button
                        color="primary"
                        [disabled]="selection.isEmpty()"
                    >
                        Ersetzen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <ng-template #noData>
        <div *ngIf="!isRunning" main-content>
            Es gibt keine Ergebnisse. Bitte starten Sie die Prüfung.
        </div>
    </ng-template>
</page-template>
