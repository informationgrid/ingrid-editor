<page-template label="Import">
    <div left-side>
        Hier können Sie verschiedene Dateien importieren und in Datensätze
        umwandeln.

        <p>
            Unterstützt wird derzeit nur das interne Format als JSON, welches
            beim Export produziert wird.
        </p>
    </div>

    <div main-header>
        <!--        TODO: extract to component since it's used several times -->
        <div fxFlex fxLayoutAlign="center center" fxLayoutGap="12px">
            <ng-container *ngIf="message as log">
                <mat-icon
                    *ngIf="log.errors?.length > 0"
                    class="error-color"
                    matTooltip="Bei der letzten Prüfung trat ein Fehler auf"
                    >error_outline
                </mat-icon>

                <span *ngIf="!importIsRunning; else running"
                    >Letzte Prüfung erfolgte am
                    {{ log.startTime | date : "dd.LL.yyyy HH:mm" }}</span
                >
                <ng-template #running>
                    <span fxLayout>
                        <mat-progress-spinner
                            [value]="log.progress"
                            diameter="16"
                            [matTooltip]="log.progress + '% analysiert'"
                        ></mat-progress-spinner>
                    </span>
                    <span>
                        Laufende Prüfung seit:
                        {{ log.startTime | date : "dd.LL.yyyy HH:mm:ss" }}</span
                    >
                </ng-template>
                <button
                    mat-icon-button
                    class="dark menu-button"
                    [class.expanded]="showMore"
                    (click)="showMore = !showMore"
                >
                    <mat-icon class="animated">keyboard_arrow_down</mat-icon>
                </button>
            </ng-container>
        </div>
    </div>

    <div status class="status" [class.hide]="!showMore">
        <div *ngIf="message as log">
            <div>Start: {{ log.startTime | date : "dd.LL.yyyy HH:mm:ss" }}</div>
            <div>Ende: {{ log.endTime | date : "dd.LL.yyyy HH:mm:ss" }}</div>
            <div>Status: Phase ... abgeschlossen</div>
            <br />
            <div *ngIf="log.errors?.length > 0">
                Fehler:
                <span data-cy="count-errors">{{ log.errors.length }}</span>
                <ul>
                    <li *ngFor="let error of log.errors">{{ error }}</li>
                </ul>
            </div>

            <ige-import-report
                *ngIf="log.report"
                [report]="log.report"
            ></ige-import-report>
        </div>
    </div>

    <section main-content fxFlex>
        <mat-horizontal-stepper #stepper [linear]="true" labelPosition="bottom">
            <mat-step [completed]="step1Complete">
                <ng-template matStepLabel>Hochladen</ng-template>

                <div *ngIf="!step1Complete; else uploadFinished">
                    <ige-file-upload
                        target="/api/jobs/import/analyze?command=start"
                        (complete)="onUploadComplete($event)"
                        (chosenFiles)="chosenFiles = $event"
                    ></ige-file-upload>
                </div>

                <ng-template #uploadFinished>
                    <div class="content">
                        <div *ngIf="message.endTime == null">
                            <div class="section-title">
                                Analyse der hochgeladenen Datei(en)
                                <!--                                {{ message.progress }} von {{}}-->
                            </div>
                            <mat-progress-spinner
                                diameter="50"
                                [value]="message.progress"
                            ></mat-progress-spinner>

                            <button mat-flat-button (click)="abortImportJob()">
                                Abbrechen
                            </button>
                        </div>

                        <div
                            *ngIf="
                                message.endTime != null &&
                                message.report != null
                            "
                        >
                            <div class="section-title">
                                Analyse abgeschlossen
                            </div>
                            <ige-import-report [report]="message.report">
                            </ige-import-report>
                        </div>
                        <!--<mat-icon class="big-icon success-color"
                            >check_circle_outline
                        </mat-icon>-->
                    </div>
                </ng-template>

                <span *ngIf="importFileErrorMessage">{{
                    importFileErrorMessage
                }}</span>

                <div class="action-bar">
                    <button
                        *ngIf="step1Complete"
                        color="primary"
                        mat-button
                        (click)="cancel()"
                    >
                        Abbrechen
                    </button>
                    <div fxFlex></div>
                    <button
                        mat-button
                        mat-flat-button
                        color="primary"
                        matStepperNext
                        [disabled]="!step1Complete"
                    >
                        Weiter
                    </button>
                </div>
            </mat-step>
            <mat-step [stepControl]="optionsFormGroup">
                <form class="content" [formGroup]="optionsFormGroup">
                    <ng-template matStepLabel>Optionen wählen</ng-template>
                    <div class="options">
                        <div class="section-title space-top">Typ</div>
                        <mat-form-field
                            appearance="outline"
                            style="width: 372px"
                        >
                            <mat-select
                                formControlName="importer"
                                placeholder="Importer auswählen"
                            >
                                <mat-option
                                    *ngFor="let importer of importers"
                                    [value]="importer.id"
                                    >{{ importer.name }}</mat-option
                                >
                            </mat-select>
                        </mat-form-field>

                        <div class="section-title">Import</div>
                        <mat-radio-group
                            class="radio-vertical"
                            formControlName="option"
                        >
                            <mat-radio-button value="overwrite_identical">
                                Identische Metadaten überschreiben
                            </mat-radio-button>
                            <mat-radio-button value="create_under_target">
                                Anlage nur unter gewähltem Importknoten
                            </mat-radio-button>
                        </mat-radio-group>

                        <div>Datensätze anlegen unter: ...</div>
                        <div>Adressen anlegen unter: ...</div>
                    </div>
                </form>

                <div class="action-bar">
                    <button mat-button color="primary" (click)="cancel()">
                        Abbrechen
                    </button>
                    <div fxFlex></div>
                    <button mat-button color="primary" matStepperPrevious>
                        Zurück
                    </button>
                    <!--<button
                        mat-button
                        mat-flat-button
                        matStepperNext
                        color="primary"
                        [disabled]="optionsFormGroup.invalid"
                        Weiter
                    >
                    </button>-->
                    <button
                        mat-button
                        mat-flat-button
                        color="primary"
                        [disabled]="optionsFormGroup.invalid"
                        matStepperNext
                        (click)="startImport()"
                    >
                        Importieren
                    </button>
                </div>
            </mat-step>
            <!--<mat-step [completed]="readyForImport">
                <ng-template matStepLabel>Ort wählen</ng-template>
                <div class="content">
                    <div class="section-title">Dokument:</div>
                    <ige-tree
                        [hideReadOnly]="false"
                        [showOnlyFolders]="true"
                        [showHeaderOptions]="false"
                        (activate)="setLocation($event, false)"
                    ></ige-tree>
                    &lt;!&ndash; FIXME: [hideReadOnly]="true" after completion of #4261 &ndash;&gt;

                    <div class="section-title space-top">Adresse:</div>
                    <ige-tree
                        [forAddresses]="true"
                        [hideReadOnly]="true"
                        [showOnlyFolders]="true"
                        [showHeaderOptions]="false"
                        (activate)="setLocation($event, true)"
                    ></ige-tree>
                </div>

                <div class="action-bar">
                    <button mat-button color="primary" (click)="cancel()">
                        Abbrechen
                    </button>
                    <div fxFlex></div>
                    <button mat-button color="primary" matStepperPrevious>
                        Zurück
                    </button>
                    <button
                        mat-button
                        mat-flat-button
                        color="primary"
                        [disabled]="!readyForImport"
                        matStepperNext
                        (click)="startImport()"
                    >
                        Importieren
                    </button>
                </div>
            </mat-step>-->
            <mat-step>
                <ng-template matStepLabel>Fertig</ng-template>
                <div class="content text-center">
                    <div class="section-title">Datei importiert:</div>

                    <ige-file-upload
                        #uploadComponent
                        showOnlyProgress="true"
                        autoupload="false"
                        target="/api/import"
                        (complete)="onFileComplete($event)"
                    ></ige-file-upload>

                    <mat-icon
                        *ngIf="hasImportError; else success"
                        class="big-icon error-color"
                        >error_outline
                    </mat-icon>
                    <ng-template #success>
                        <mat-icon class="big-icon success-color"
                            >check_circle_outline
                        </mat-icon>

                        <div class="section-title">Ort:</div>
                        <ige-breadcrumb
                            [path]="pathToDocument"
                        ></ige-breadcrumb>
                        <button
                            mat-button
                            mat-stroked-button
                            color="primary"
                            (click)="openImportedDocument()"
                        >
                            Öffnen
                        </button>
                    </ng-template>
                </div>

                <div class="action-bar" fxLayoutAlign="end">
                    <button
                        mat-button
                        mat-flat-button
                        color="primary"
                        (click)="cancel()"
                    >
                        Neuer Import
                    </button>
                </div>
            </mat-step>
        </mat-horizontal-stepper>
    </section>
</page-template>

<ng-template #uploader>
    <ige-file-upload
        #uploadComponent
        target="/api/import/analyze"
        (complete)="onUploadComplete($event)"
        (chosenFiles)="chosenFiles = $event"
    ></ige-file-upload>
</ng-template>
