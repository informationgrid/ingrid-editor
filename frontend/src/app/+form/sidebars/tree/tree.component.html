<div class="header-wrapper" *transloco="let t; read: 'menu'">
    <ige-tree-header
        *ngIf="showHeader"
        [class.invisible]="isDragging && hasWriteToRootPermission"
        (reload)="reloadTree(true).subscribe()"
        [isAddress]="forAddresses"
        [showOptions]="showHeaderOptions"
        [showOnlyFolders]="showOnlyFolders"
        [showMultiSelectButton]="hasData && showMultiSelectButton"
        [showSearch]="hasData"
        [emptySearchResults]="emptySearchResults"
        [checkToggleAll]="selection.allNodesSelected()"
        [indeterminateToggleAll]="selection.atLeastOneButNotAllNodesSelected()"
        [multiSelectionModeEnabled]="selection.multiSelectionModeEnabled"
        (toggleAllSelection)="selection.toggleAllSelection($event)"
        (toggleView)="toggleView($event)"
        (edit)="toggleSelectionMode($event)"
        (open)="handleSelection($event)"
    ></ige-tree-header>

    <div
        *ngIf="isDragging && hasWriteToRootPermission"
        class="drop-root"
        [class.hover]="dragManager.dragNodeExpandOverNode === null"
        (dragover)="dragManager.handleDragOver($event, null)"
        (drop)="drop($event, null)"
    >
        <div class="zone">
            <span
                >Ablegen unter: <mat-icon svgIcon="Ordner"></mat-icon>
                {{ forAddresses ? "Adressen" : t("form") }}</span
            >
        </div>
    </div>
</div>

<!-- TODO: trackBy does not update isExpanded Flag: see https://github.com/angular/components/issues/15872 [trackBy]="trackByNodeId"-->
<mat-tree
    #treeComponent
    [dataSource]="dataSource"
    [treeControl]="treeControl"
    *transloco="let t"
>
    <!-- cdkDropList (cdkDropListDropped)="drop($event)">-->

    <!-- This is the tree node template for leaf nodes -->
    <mat-tree-node
        *matTreeNodeDef="let node"
        [draggable]="enableDrag"
        (dragover)="isDragging && dragManager.handleDragOver($event, node)"
        (drop)="drop($event, node)"
        (dragstart)="handleDragStart($event, node)"
        (dragend)="handleDragEnd()"
        matTreeNodePadding
        matTreeNodePaddingIndent="24"
        (click)="!disabledCondition(node) && selectNode(node, $event)"
        [class.drop]="isDragging && dragManager.dragNodeExpandOverNode === node"
        [class.active]="node._id === activeNodeId"
        [class.expanded]="node.isExpanded"
        [class.hide]="showOnlyFolders"
        [class.readonly]="!node.hasWritePermission"
        [class.rootNode]="node.level === 0"
        [class.afterExpanded]="node.afterExpanded"
        [class.disabled]="disabledCondition(node)"
        [attr.tabindex]="!disabledCondition(node) ? 0 : null"
        (keydown.enter)="!disabledCondition(node) && selectNode(node, $event)"
    >
        <div style="width: 100%">
            <div class="flex-row">
                <button
                    mat-icon-button
                    class="toggle"
                    matTreeNodeToggle
                    [disabled]="!isExpandable(node)"
                    [attr.aria-label]="'toggle ' + node.title"
                >
                    <mat-icon
                        *ngIf="isExpandable(node)"
                        class="mat-icon-rtl-mirror expander animated"
                    >
                        {{ isLoading === node ? "autorenew" : "chevron_right" }}
                    </mat-icon>
                </button>
            </div>

            <div class="label">
                <mat-checkbox
                    *ngIf="selection.multiSelectionModeEnabled"
                    [class.docNode]="node.level !== 0"
                    [checked]="selection.isSelected(node)"
                    (click)="$event.stopImmediatePropagation()"
                    (change)="selection.nodeSelectionToggle(node, $event)"
                ></mat-checkbox>
                <mat-icon
                    [svgIcon]="node.iconClass"
                    [ngClass]="['document-icon', getStateClass(node)]"
                    [matTooltipShowDelay]="1000"
                    [matTooltip]="t('docType.' + node.type)"
                ></mat-icon>
                <!-- TODO: replace with matTooltip and matTooltipShowDelay when https://github.com/angular/components/pull/24652 is merged -->
                <span title="{{ node.title }}">{{ node.title }}</span>
            </div>
        </div>
    </mat-tree-node>

    <!-- This is the tree node template for expandable nodes -->
    <mat-tree-node
        *matTreeNodeDef="let node; when: isFolder"
        [draggable]="enableDrag"
        (drop)="isDragging && drop($event, node)"
        (dragstart)="handleDragStart($event, node)"
        (dragover)="isDragging && dragManager.handleDragOver($event, node)"
        (dragend)="handleDragEnd()"
        matTreeNodePadding
        matTreeNodePaddingIndent="24"
        (click)="handleFolderClick(node, $event)"
        [class.drop]="isDragging && dragManager.dragNodeExpandOverNode === node"
        [class.active]="node._id === activeNodeId"
        [class.expanded]="node.isExpanded"
        [class.readonly]="!node.hasWritePermission"
        [class.rootNode]="node.level === 0"
        [class.afterExpanded]="node.afterExpanded"
        [class.disabled]="disabledCondition(node)"
        [class.folder]="node.type === 'FOLDER'"
    >
        <div style="width: 100%">
            <div class="flex-row">
                <button
                    mat-icon-button
                    class="toggle"
                    matTreeNodeToggle
                    [disabled]="!isExpandable(node)"
                    [attr.aria-label]="'toggle ' + node.title"
                >
                    <mat-icon
                        *ngIf="isExpandable(node)"
                        class="mat-icon-rtl-mirror expander animated"
                    >
                        {{ isLoading === node ? "autorenew" : "chevron_right" }}
                    </mat-icon>
                </button>
            </div>

            <div class="label">
                <mat-checkbox
                    *ngIf="selection.showFolderCheckbox()"
                    (change)="selection.nodeSelectionToggle(node, $event)"
                    (click)="$event.stopImmediatePropagation()"
                    [checked]="selection.isSelected(node)"
                ></mat-checkbox>

                <span>{{ node.title }}</span>
                <ng-container *ngIf="node.isLoading">
                    <mat-spinner diameter="18"></mat-spinner>
                </ng-container>
            </div>
        </div>
    </mat-tree-node>
</mat-tree>

<ige-empty-navigation *ngIf="!hasData"></ige-empty-navigation>
