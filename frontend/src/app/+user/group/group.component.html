<div fxLayout="column" fxFill class="page-wrapper">
    <div class="header-wrapper">
        <div class="user-management-header">
            <div class="page-title">
                Gruppen {{ groups ? "(" + groups.length + ")" : "" }}
            </div>
            <mat-toolbar>
                <mat-toolbar-row>
                    <!--            Searchfield-->
                    <ige-search-field
                        (queryUpdate)="this.searchQuery = $event"
                    ></ige-search-field>
                    <div fxFlex></div>

                    <span class="save-buttons">
                        <button
                            color="primary"
                            mat-stroked-button
                            (click)="openAddGroupDialog()"
                            matTooltip="Gruppe hinzufügen"
                            [matTooltipShowDelay]="1000"
                        >
                            <mat-icon>person_add</mat-icon> Hinzufügen
                        </button>
                        <button
                            class="btnSave"
                            mat-flat-button
                            color="primary"
                            data-cy="toolbar_save_group"
                            matTooltip="Speichern"
                            [matTooltipShowDelay]="1000"
                            (click)="saveGroup()"
                            [disabled]="form?.invalid || !form?.dirty"
                        >
                            Speichern
                        </button>
                    </span>
                </mat-toolbar-row>
            </mat-toolbar>
        </div>
    </div>
    <as-split (dragEnd)="this.userManagementService.rememberTableWidth($event)">
        <!-- TODO: restrict role permission to groups! A simple user must not change his own role to admin!!! -->

        <!-- GROUP LIST -->
        <as-split-area
            [size]="tableWidth"
            id="sidebarRoles"
            class="split-pane-content-primary container"
        >
            <groups-table
                [query]="searchQuery"
                [groups]="groups"
                [userGroupNames]="userGroupNames"
                [selectedGroup]="groupService.selectedGroup$"
                (onGroupSelect)="loadGroup($event.id)"
                (onDelete)="deleteGroup($event)"
            ></groups-table>
        </as-split-area>

        <!-- GROUP DETAIL -->
        <as-split-area
            [size]="100 - tableWidth"
            id="formRoles"
            class="split-pane-content-secondary container-fluid"
            style="display: block"
        >
            <form
                *ngIf="selectedGroup; else noGroupOrLoading"
                fxLayout="column"
                fxFill
                [formGroup]="form"
                class="detail-role"
            >
                <div class="user-title">
                    <div class="document-type">
                        <mat-icon
                            [svgIcon]="
                                userGroupNames.includes(form.get('name')?.value)
                                    ? 'group'
                                    : 'group-standin'
                            "
                        ></mat-icon>
                    </div>

                    <span fxFlex class="label" [class.editable]="false">
                        <span>{{
                            form.get("name")?.value || "Kein Titel"
                        }}</span>
                    </span>

                    <button
                        mat-icon-button
                        class="dark menu-button"
                        [class.expanded]="showMore"
                        (click)="this.showMore = !this.showMore"
                    >
                        <mat-icon class="rotating animated"
                            >keyboard_arrow_down
                        </mat-icon>
                    </button>
                    <button
                        mat-icon-button
                        class="menu dark menu-button"
                        [matMenuTriggerFor]="groupMoreMenu"
                    >
                        <mat-icon svgIcon="Mehr"></mat-icon>
                    </button>
                    <mat-menu #groupMoreMenu="matMenu">
                        <!--                        <button
                            disabled
                            mat-menu-item
                            (click)="openChangeManagerDialog()"
                        >
                            Verantwortlichen ändern
                        </button>-->
                        <button
                            mat-menu-item
                            (click)="showGroupUsers(selectedGroup.id)"
                        >
                            Nutzer anzeigen
                        </button>
                        <button
                            mat-menu-item
                            (click)="deleteGroup(selectedGroup.id)"
                        >
                            Löschen
                        </button>
                    </mat-menu>
                </div>
                <group-header-more
                    [showMore]="this.showMore"
                    [group]="selectedGroup"
                ></group-header-more>
                <!-- TITLE -->
                <mat-form-field appearance="outline">
                    <mat-label>Name</mat-label>
                    <input matInput formControlName="name" />
                    <mat-error *ngIf="form.get('name').errors?.forbiddenName"
                        >Es gibt bereits eine Gruppe mit diesem Namen
                    </mat-error>
                </mat-form-field>

                <!-- DESCRIPTION -->
                <mat-form-field appearance="outline">
                    <mat-label>Beschreibung</mat-label>
                    <textarea matInput formControlName="description"></textarea>
                </mat-form-field>

                <ige-permissions
                    formControlName="permissions"
                ></ige-permissions>
            </form>

            <!-- NO GROUP SELECTED -->
            <ng-template #noGroupOrLoading>
                <div
                    *ngIf="!isLoading; else loading"
                    fxFlex
                    fxLayout="column"
                    fxLayoutAlign="center center"
                    class="detail-role no-selection-placeholder"
                >
                    <div>
                        <img
                            src="assets/icons/group-management.png"
                            alt="group-management"
                        />
                    </div>
                    <div class="no-selection-text">
                        Wählen Sie einen Eintrag aus, um Berechtigungen
                        anzuzeigen oder Änderungen durchzuführen.
                    </div>
                </div>
            </ng-template>
            <ng-template #loading>
                <mat-spinner style="margin: 100px auto"></mat-spinner>
            </ng-template>
        </as-split-area>
    </as-split>
</div>
