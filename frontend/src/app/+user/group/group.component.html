<div fxLayout="column" fxFill class="allPageScroll">
    <div class="page-wrapper" fxLayout="column">
        <div class="header-wrapper">
            <div class="user-management-header">
                <div class="page-title">
                    Gruppen ({{ (groups | async)?.length }})
                </div>
                <mat-toolbar>
                    <mat-toolbar-row>
                        <!--            Searchfield-->
                        <ige-search-field
                            (queryUpdate)="this.searchQuery = $event"
                        ></ige-search-field>
                        <div fxFlex></div>

                        <span class="save-buttons">
                            <button
                                color="primary"
                                mat-stroked-button
                                (click)="openAddGroupDialog()"
                                matTooltip="Gruppe hinzufügen"
                                [matTooltipShowDelay]="1000"
                            >
                                <mat-icon>person_add</mat-icon> Hinzufügen
                            </button>
                            <button
                                class="btnSave"
                                mat-flat-button
                                color="primary"
                                data-cy="toolbar_save_group"
                                matTooltip="Speichern"
                                [matTooltipShowDelay]="1000"
                                (click)="saveGroup()"
                                [disabled]="form?.invalid || !form?.dirty"
                            >
                                Speichern
                            </button>
                        </span>
                    </mat-toolbar-row>
                </mat-toolbar>
            </div>
        </div>
        <as-split
            (dragEnd)="this.userManagementService.rememberTableWidth($event)"
        >
            <!-- TODO: restrict role permission to groups! A simple user must not change his own role to admin!!! -->

            <!-- GROUP LIST -->
            <as-split-area
                [size]="tableWidth"
                id="sidebarRoles"
                class="split-pane-content-primary container"
            >
                <groups-table
                    [query]="searchQuery"
                    [groups]="groups | async"
                    [userGroupNames]="userGroupNames"
                    [selectedGroup]="groupQuery.selectActiveId()"
                    (onGroupSelect)="groupService.setActive($event.id)"
                    (onDelete)="deleteGroup($event)"
                ></groups-table>
            </as-split-area>

            <!-- GROUP DETAIL -->
            <as-split-area
                [size]="100 - tableWidth"
                id="formRoles"
                class="split-pane-content-secondary container-fluid"
                style="display: block"
            >
                <ng-container *ngIf="!isLoading; else loading">
                    <ng-container *ngIf="selectedGroup; else noGroupSelected">
                        <form
                            fxLayout="column"
                            fxLayoutGap="12px"
                            fxFill
                            [formGroup]="form"
                            class="detail-role"
                        >
                            <div class="user-title">
                                <div class="document-type">
                                    <mat-icon svgIcon="group"></mat-icon>
                                </div>

                                <span
                                    fxFlex
                                    class="label"
                                    [class.editable]="false"
                                >
                                    <span>{{
                                        form.get("name")?.value || "Kein Titel"
                                    }}</span>
                                </span>

                                <button
                                    mat-icon-button
                                    class="dark menu-button"
                                    [class.expanded]="showMore"
                                    (click)="this.showMore = !this.showMore"
                                >
                                    <mat-icon class="rotating animated"
                                        >keyboard_arrow_down
                                    </mat-icon>
                                </button>
                                <button
                                    mat-icon-button
                                    class="menu dark menu-button"
                                    [matMenuTriggerFor]="groupMoreMenu"
                                >
                                    <mat-icon svgIcon="Mehr"></mat-icon>
                                </button>
                                <mat-menu #groupMoreMenu="matMenu">
                                    <button
                                        mat-menu-item
                                        (click)="
                                            showGroupUsers(selectedGroup.id)
                                        "
                                    >
                                        Benutzer anzeigen
                                    </button>
                                    <button
                                        [disabled]="
                                            selectedGroup.currentUserIsMember
                                        "
                                        mat-menu-item
                                        (click)="deleteGroup(selectedGroup.id)"
                                    >
                                        Löschen
                                    </button>
                                </mat-menu>
                            </div>
                            <group-header-more
                                [showMore]="this.showMore"
                                [group]="selectedGroup"
                            ></group-header-more>
                            <div
                                *ngIf="selectedGroup.currentUserIsMember"
                                class="no-fields-selected-notice warn"
                            >
                                <div class="infoIcon">
                                    <mat-icon
                                        class="material-icons-outlined"
                                        svgIcon="info-24px"
                                    ></mat-icon>
                                </div>
                                <span>
                                    Für Mitglieder der Gruppe ist die
                                    Bearbeitung deaktiviert.</span
                                >
                            </div>
                            <!-- TITLE -->
                            <mat-form-field appearance="outline">
                                <mat-label>Name</mat-label>
                                <input matInput formControlName="name" />
                                <mat-error
                                    *ngIf="
                                        form.get('name').errors?.forbiddenName
                                    "
                                    >Es gibt bereits eine Gruppe mit diesem
                                    Namen
                                </mat-error>
                            </mat-form-field>

                            <!-- DESCRIPTION -->
                            <mat-form-field appearance="outline">
                                <mat-label>Beschreibung</mat-label>
                                <textarea
                                    matInput
                                    formControlName="description"
                                ></textarea>
                            </mat-form-field>

                            <ige-permissions
                                [disabled]="selectedGroup.currentUserIsMember"
                                [showRootReadSlider]="
                                    userHasRootReadPermission ||
                                    userHasRootWritePermission
                                "
                                [showRootWriteSlider]="
                                    userHasRootWritePermission
                                "
                                formControlName="permissions"
                            ></ige-permissions>
                            <div>
                                <div class="section-title">
                                    Zugeordnete Benutzer
                                    <span *ngIf="groupUsers"
                                        >({{ groupUsers.length }})</span
                                    >
                                </div>
                            </div>
                            <mat-divider></mat-divider>
                            <user-table
                                [users]="groupUsers"
                                [simple]="true"
                                (onUserSelect)="switchToUser($event)"
                            ></user-table>
                        </form>
                    </ng-container>

                    <!-- NO GROUP SELECTED -->

                    <ng-template #noGroupSelected>
                        <div
                            *ngIf="(groups | async)?.length > 0"
                            fxFlex
                            fxLayout="column"
                            fxLayoutAlign="center center"
                            class="detail-role no-selection-placeholder"
                        >
                            <div>
                                <img
                                    src="assets/icons/group-management.png"
                                    alt="group-management"
                                />
                            </div>
                            <div class="no-selection-text">
                                Wählen Sie einen Eintrag aus, um Berechtigungen
                                anzuzeigen oder Änderungen durchzuführen.
                            </div>
                        </div>
                        <div
                            *ngIf="(groups | async)?.length === 0"
                            fxFlex
                            fxLayout="column"
                            fxLayoutAlign="center center"
                            class="detail-role no-selection-placeholder"
                        >
                            <div>
                                <img
                                    src="assets/icons/group-management.png"
                                    alt="group-management"
                                />
                            </div>
                            <div class="no-selection-text">
                                Noch keine Gruppen erstellt!
                            </div>
                            <div class="no-selection-text">
                                Mit der oben stehenden Funktion „Hinzufügen“
                                können Sie Gruppen anlegen.
                            </div>
                        </div>
                    </ng-template>
                </ng-container>
                <ng-template #loading>
                    <mat-spinner style="margin: 100px auto"></mat-spinner>
                </ng-template>
            </as-split-area>
        </as-split>
    </div>
</div>
