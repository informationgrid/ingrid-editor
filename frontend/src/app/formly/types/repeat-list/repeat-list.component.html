<mat-chip-listbox
    *ngIf="props.view === 'chip' && field.fieldGroup?.length > 0"
    [disabled]="formControl.disabled"
    cdkDropListGroup
    mixedCdkDragDrop
    orientation="horizontal"
    (dropped)="drop($event)"
    role="list"
    [attr.aria-label]="props.ariaLabel"
>
    <span
        *ngFor="let field of field.fieldGroup; let i = index"
        cdkDropList
        mixedCdkDropList
        tabindex="0"
        role="listitem"
        (keydown.enter)="removeItem(i)"
        aria-description="Klick auf die Eingabetaste zu entfernen"
    >
        <mat-chip-option
            disableRipple
            cdkDrag
            data-cy="list-item"
            [cdkDragDisabled]="formControl.disabled"
            [removable]="true"
            [selectable]="false"
            (removed)="removeItem(i)"
        >
            <mat-icon
                *ngIf="props.showLanguage"
                class="avatar gray"
                svgIcon="language-24px"
            ></mat-icon>

            <ng-container *ngIf="!props.labelField">
                <div class="label">
                    {{ getParameter(model[i]) }}
                </div>
            </ng-container>

            <ng-container *ngIf="props.labelField">
                <div class="label">{{ model[i][props.labelField] }}</div>
            </ng-container>

            <button *ngIf="formControl.enabled" matChipRemove>
                <mat-icon>cancel</mat-icon>
            </button>
        </mat-chip-option>
    </span>
</mat-chip-listbox>

<div
    *ngIf="
        props.view !== 'chip' && field.fieldGroup?.length > 0;
        else noFieldsSelected
    "
    class="component-list"
    cdkDropList
    cdkDropListOrientation="vertical"
    (cdkDropListDropped)="drop($event)"
>
    <div
        *ngFor="let field of field.fieldGroup; let i = index"
        cdkDrag
        [cdkDragDisabled]="
            props.noDrag || formControl.disabled || model?.length < 2
        "
        class="clickable list-item"
        data-cy="list-item"
        tabindex="0"
        (keydown.delete)="removeItem(i, $event)"
        (keydown.backspace)="removeItem(i, $event)"
        (click)="this.onItemClick(model[i]?.key)"
    >
        <div class="text-wrapper">
            <span class="list-display-element">
                <mat-icon
                    *ngIf="this.props.elementIcon"
                    [svgIcon]="this.props.elementIcon"
                ></mat-icon>
                <ng-container *ngIf="type !== 'search'">
                    {{ getParameter(model[i]) }}
                </ng-container>
                <ng-container *ngIf="type === 'search'">
                    <div class="label">{{ model[i][props.labelField] }}</div>
                </ng-container>
            </span>
        </div>
        <button
            *ngIf="formControl.enabled"
            type="button"
            mat-icon-button
            class="close gray"
            (click)="removeItem(i)"
        >
            <!--            <mat-icon svgIcon="Entfernen"></mat-icon>-->
            <mat-icon>close</mat-icon>
        </button>
    </div>
</div>
<ng-template #noFieldsSelected>
    <div
        *ngIf="this.props.selectionEmptyNotice"
        class="no-fields-selected-notice"
    >
        <div class="infoIcon">
            <mat-icon
                class="material-icons-outlined"
                svgIcon="info-24px"
            ></mat-icon>
        </div>
        <span>{{ this.props.selectionEmptyNotice }}</span>
    </div>
</ng-template>

<mat-form-field
    *ngIf="type === 'select'"
    appearance="outline"
    class="width-100"
>
    <mat-select
        [placeholder]="props.placeholder"
        (valueChange)="addToList($event)"
        [formControl]="inputControl"
        (keydown)="handleKeydown($event)"
        (blur)="inputControl.setValue('')"
        [aria-label]="props.ariaLabel"
    >
        <mat-option *ngIf="props.showSearch">
            <ngx-mat-select-search
                [formControl]="filterCtrl"
            ></ngx-mat-select-search>
        </mat-option>
        <mat-option
            *ngFor="let option of filteredOptions | async"
            [value]="option"
            [disabled]="option.disabled"
        >
            <div (click)="onOptionClick($event, option)">
                {{ option.label }}
            </div>
        </mat-option>
    </mat-select>
    <!-- help info button -->
    <ng-container
        *ngIf="props.suffix"
        matSuffix
        [ngTemplateOutlet]="props.suffix"
    ></ng-container>
    <mat-error>Bitte erstellen Sie mindestens einen Eintrag</mat-error>
</mat-form-field>

<ng-container *ngIf="type === 'autocomplete'">
    <mat-form-field appearance="outline" class="width-100">
        <mat-label *ngIf="props.fieldLabel">{{ props.fieldLabel }}</mat-label>
        <input
            type="text"
            [placeholder]="props.placeholder"
            matInput
            [formControl]="inputControl"
            (keydown.enter)="addFreeEntry(inputControl.value)"
            [matAutocomplete]="auto"
            [errorStateMatcher]="matcher"
            (focusin)="hasFocus = true"
            (focusout)="hasFocus = false"
        />
        <mat-autocomplete
            #auto="matAutocomplete"
            (optionSelected)="addToList($event.option.value)"
        >
            <mat-option
                *ngFor="let option of filteredOptions | async"
                [value]="option"
                [disabled]="option.disabled"
            >
                {{ option.label }}
            </mat-option>
        </mat-autocomplete>

        <!-- clean button -->
        <button
            *ngIf="inputControl.value?.length > 0"
            mat-icon-button
            matSuffix
            type="button"
            class="field-close"
            (click)="inputControl.setValue('')"
        >
            <mat-icon>close</mat-icon>
        </button>

        <!-- help info button -->
        <ng-container
            *ngIf="props.suffix"
            matSuffix
            [ngTemplateOutlet]="props.suffix"
        ></ng-container>

        <mat-hint *ngIf="!parameterOptions">{{ props.hint }} </mat-hint>
        <mat-error>{{
            inputControl.errors?.mustBeEmpty
                ? "Der Inhalt muss noch mit 'Return' best채tigt werden"
                : "Bitte erstellen Sie mindestens einen Eintrag"
        }}</mat-error>
    </mat-form-field>
</ng-container>

<ng-container *ngIf="type === 'search'">
    <ige-search-input
        [autocompleteRef]="searchAuto"
        [withWhiteBorder]="false"
        [searchSub]="searchSub"
        [query]="inputControl"
        [flexWidth]="true"
        [placeholder]="props.placeholder"
        [focus]="false"
        [errorText]="
            inputControl.errors?.mustBeEmpty
                ? 'Der Inhalt muss noch mit \'Return\' best채tigt werden'
                : null
        "
        showSearchIcon="true"
    ></ige-search-input>

    <mat-autocomplete
        #searchAuto="matAutocomplete"
        [autoActiveFirstOption]="true"
        (optionSelected)="addValueObject($event.option.value)"
    >
        <mat-option *ngFor="let doc of searchResult | async" [value]="doc">
            {{ getLabel(doc) }}
        </mat-option>
    </mat-autocomplete>
</ng-container>

<ng-container *ngIf="type === 'simple' && formControl.enabled">
    <mat-form-field class="width-100" appearance="outline">
        <input
            matInput
            [placeholder]="props.placeholder"
            autocomplete="off"
            [formControl]="inputControl"
            [required]="showError && props.required && formControl.invalid"
            (keydown.enter)="addSimpleValues(inputControl.value)"
            [errorStateMatcher]="matcher"
            (focusin)="hasFocus = true"
            (focusout)="hasFocus = false"
            [attr.aria-label]="props.ariaLabel"
            aria-description="Die Eingabe muss noch mit 'Return' best채tigt werden"
        />
        <div matSuffix>
            <mat-spinner
                *ngIf="searchSub && !searchSub.closed"
                [diameter]="24"
            ></mat-spinner>
            <button
                *ngIf="inputControl.value?.length > 0"
                mat-icon-button
                type="button"
                class="field-close"
                (click)="inputControl.setValue('')"
            >
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <mat-hint>{{ props.hint }} </mat-hint>
        <mat-error>{{
            inputControl.errors?.mustBeEmpty
                ? "Der Inhalt muss noch mit 'Return' best채tigt werden"
                : "Bitte erstellen Sie mindestens einen Eintrag"
        }}</mat-error>
    </mat-form-field>
</ng-container>
